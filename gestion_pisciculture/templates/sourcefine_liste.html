{% extends 'base.html' %} 

{% block content %}

{% load humanize %}
{% load custom_filters %}

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <!-- <h1 class="h3 mb-2 text-gray-800">Tables</h1>
                    <p class="mb-4">DataTables is a third party plugin that is used to generate the demo table below.
                        For more information about DataTables, please visit the <a target="_blank"
                            href="https://datatables.net">official DataTables documentation</a>.</p> -->

                    <!-- DataTales Example -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Liste des sources de financement</h6>

                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <a href="{% url 'ajouter_historique_sourcefine' %}" class="btn btn-success">Ajouter un nouveau financement</a>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Nom</th>
                                            <th>Solde</th>
                                            <th>Etat</th>
                                            <th>Date d'ajout</th>
                                            <th>Date Modif</th>
                                            <th>Actions</th> <!-- Colonne pour les actions -->
                                        </tr>
                                    </thead>
                                  

                                    <tbody>
                                        {% for sourcefine in sourcefines %}
                                       
                                            <tr class="source-row" data-id="{{ sourcefine.id }}">
                                            <td>{{ sourcefine.nom }}</td>
                                            <td>{{ sourcefine.solde }}</td>
                                            <td>{{ sourcefine.etat }}</td>
                                            <td>{{ sourcefine.dateajout }}</td>
                                            <td>{{ sourcefine.datemotif }}</td>
                                            <td>
                                                <!-- Bouton de modification -->
                                                 <form action="{% url 'modifier_sourcefine' %}" method="get" style="display:inline;">
                                                   {% csrf_token %}
                                                    <input type="hidden" name="id" value="{{ sourcefine.id }}">
                                                     <button class="btn btn-primary btn-circle"><i class="fas fa-wrench"></i></button>
                                                 </form>
                                                
                                               
                                                <!-- Bouton de suppression -->
                                                <form action="{% url 'supprimer_sourcefine' %}" method="GET" style="display:inline;">
                                                    {% csrf_token %}
                                                      <input type="hidden" name="id" value="{{ sourcefine.id }}">
                                                    <button type="submit" class="btn btn-danger btn-circle" onclick="return confirm('Voulez-vous vraiment supprimer cette source de financement ?');"><i class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->

                <div class="container-fluid">

                    <!-- Page Heading -->
                    <!-- <h1 class="h3 mb-2 text-gray-800">Tables</h1>
                    <p class="mb-4">DataTables is a third party plugin that is used to generate the demo table below.
                        For more information about DataTables, please visit the <a target="_blank"
                            href="https://datatables.net">official DataTables documentation</a>.</p> -->

                    <!-- DataTales Example -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Historique des financements</h6>

                        </div>
                        <div class="card-body">
                            <!-- <div class="mb-3">
                                <a href="{% url 'ajouter_historique_sourcefine' %}" class="btn btn-success">Ajouter un nouveau financement</a>
                            </div> -->
                            <div class="table-responsive">
                                <table class="table table-bordered" id="historique-table" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Source Fine</th>
                                            <th>Montant</th>
                                            <th>Date d'ajout</th>
                                            <th>Date Modif</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Les données seront insérées ici via JavaScript -->
                                    </tbody>
                                </table>
                                
                            </div>
                        </div>
                    </div>

                </div>
           
    <!-- End of Page Wrapper -->



    <style>
        /* Style pour la ligne sélectionnée */
        .source-row.selected {
            background-color: #007bff; /* Fond bleu */
            color: white; /* Texte en blanc pour contraster avec le fond bleu */
            font-weight: bold; /* Texte en gras */
            border-left: 4px solid blue; /* Souligner avec une bordure gauche bleue */
        }
    </style>
    
    <script>
        function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

       document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll(".source-row");
    rows.forEach(row => {
        row.addEventListener("click", function () {
            const sourceId = this.dataset.id;

            // Retirer la classe 'selected' des autres lignes
            rows.forEach(r => r.classList.remove('selected')); // Supprime la sélection des autres lignes
            // Ajouter la classe 'selected' à la ligne cliquée
            this.classList.add('selected'); // Marque la ligne courante comme sélectionnée

            // Requête AJAX pour récupérer l'historique
            fetch(`/get_historique_sourcefine/${sourceId}/`, {
                method: "GET",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.json())
            .then(data => {
                // Mise à jour du tableau Historique
                const historiqueTable = document.querySelector("#historique-table tbody");
                historiqueTable.innerHTML = ""; // Vider le tableau avant ajout
                data.forEach(historique => {
                    const row = `
                        <tr>
                            <td>${historique.sourcefine}</td>
                            <td>${historique.Montant}</td>
                            <td>${historique.dateajout}</td>
                            <td>${historique.datemotif}</td>
                            <td>
                                ${historique.id}
                                <!-- Actions -->
                                <button class="btn btn-primary btn-circle btn-modifier" data-id="${historique.id}"><i class="fas fa-wrench"></i></button>
                                <button class="btn btn-danger btn-circle btn-supprimer" data-id="${historique.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    historiqueTable.innerHTML += row;
                });

                // Ajouter les gestionnaires d'événements pour les boutons Modifier et Supprimer
                attachActionHandlers();
            })
            .catch(error => console.error("Erreur :", error));
        });
    });
    

    // Fonction pour attacher les gestionnaires d'événements aux boutons Modifier et Supprimer
    function attachActionHandlers() {
        const btnsModifier = document.querySelectorAll(".btn-modifier");
        const btnsSupprimer = document.querySelectorAll(".btn-supprimer");

        btnsModifier.forEach(btn => {
            btn.addEventListener("click", function () {
                const id = this.dataset.id;
                console.log("ID récupéré :", id);

                modifier_historique_sourcefine(id); // Appeler la fonction pour modifier
            });
        });

        btnsSupprimer.forEach(btn => {
            btn.addEventListener("click", function () {
                const id = this.dataset.id;
                supprimer_historique_sourcefine(id); // Appeler la fonction pour supprimer
            });
        });
    }

    function modifier_historique_sourcefine(id) {
    console.log(`Modifier l'historique avec l'ID : ${id}`);
    // Rediriger l'utilisateur vers la page de modification du formulaire
    window.location.href = `/modifier_historique_sourcefine/${id}/`;
}


function supprimer_historique_sourcefine(id) {
    // Implémentez ici la logique pour supprimer l'historique
    console.log(`Supprimer l'historique avec l'ID : ${id}`);
    // Par exemple, afficher une confirmation et envoyer une requête AJAX
    if (confirm("Voulez-vous vraiment supprimer cet historique ?")) {
        fetch(`/supprimer_historique_sourcefine/${id}/`, {
            method: "DELETE",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrftoken // Ajoutez le token CSRF ici
            }
        })
        .then(response => {
            if (response.ok) {
                alert("Historique supprimé avec succès !");
                // Rafraîchir la liste si nécessaire
                document.querySelector(`button[data-id="${id}"]`).closest("tr").remove();
            } else {
                alert("Erreur lors de la suppression.");
            }
        })
        .catch(error => console.error("Erreur :", error));
    }
}

});


    </script>

{% endblock content %}